<!--<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>-->
<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="./vk-icon-toggle.html">
<link rel="import" href="./vk-simple-overlay.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.2/socket.io.js"></script>
<script src="/lib/sharedb_client.js"></script>
<dom-module id="vk-remote-control">
    <script type="text/javascript">
        Polymer({
            is: 'vk-remote-control',
            properties: {
                dataSets: {
                    type: Array,
                    notify: true,
                    reflectToAttribute: true
                },
                // Downward flow
                mapConfig: {
                    type: Object,
                    notify: false,
                    reflectToAttribute: true,
                    readOnly: false
                },
                mapConfigRequest: {
                    type: Object,
                    notify: true,
                    readOnly: true,
                    reflectToAttribute: true
                }
            },
            observers: [
                '_handleMapConfigChanged(mapConfig.*)'
            ],
            attached: function() {
                console.log('attach vkrc');
                var socket = new WebSocket('ws://localhost:8080');
                var connection = new sharedb.Connection(socket);
                var doc = connection.get('examples', 'counter');
                // Get initial value of document and subscribe to changes
                doc.subscribe(showNumbers);
                // When document changes (by this client or any other, or the server),
                // update the number on the page
                doc.on('op', showNumbers);

                function showNumbers() {
                    console.log(doc.data.numClicks);
                };
            },
            _handleMapConfigChanged: function() {
                console.log('rc mapconfig change')
                console.log(this.id);
                if (this.mapConfig[this.id]) {
                    this._emitMapConfigChanged();
                }

            },
            _handleSocketMsg: function(data) {
                console.log('rc socket msg received');
                console.log(data);
                request = {};
                request[this.id] = data.mapConfig;
                this._setMapConfigRequest(request);
            },
            _emitMapConfigChanged: function() {
                if (this.socket) {
                    console.log('emit control');
                    //this.socket.emit('update_map', {
                    //    'mapConfig': this.mapConfig[this.id]
                    //});
                }
            }
        });
    </script>
</dom-module>
