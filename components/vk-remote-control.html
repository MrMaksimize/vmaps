<!--<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>-->
<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="./vk-icon-toggle.html">
<link rel="import" href="./vk-simple-overlay.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.2/socket.io.js"></script>
<dom-module id="vk-remote-control">
    <script type="text/javascript">
        Polymer({
            is: 'vk-remote-control',
            properties: {
                active: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                dataSets: {
                    type: Array,
                    notify: true,
                    reflectToAttribute: true
                },
                zoomLevel: {
                    type: Number,
                    value: 7,
                    notify: true,
                    reflectToAttribute: true
                },
                lonLat: {
                    type: Array,
                    notify: true,
                    reflectToAttribute: true
                }
            },
            observers: [
                //TODO -- these three should be an object
                '_emit(lonLat.*, zoomLevel)'
                //'_updateMapData(dataSets.*)'
            ],
            //listeners: {
            //    'vk-map-moved': '_emit'
            //},

            attached: function() {
                console.log('ready');
                this.socket = io('http://localhost:3000');
                var self = this;
                console.log(this.socket);
                this.socket.on('connect', function(){
                    console.log('connected');
                    self.socket.on('update_map', function(data){
                      self.handleSocketMsg(data)
                    });
                });
            },
            handleSocketMsg: function(data) {
                this._data = data;
                this.debounce('receive', function() {
                    console.log(this._data.lonLat);
                    if ((this._data.lonLat && typeof this._data.lonLat[0] === "number" && typeof this._data.lonLat[1] === "number" && this.lonLat) &&
                        (this._data.lonLat[0] !== this.lonLat[0] || this._data.lonLat[1] !== this.lonLat[1])) {
                        this.set('lonLat', this._data.lonLat);
                    }
                    debugger
                    if (this._data.zoomLevel && typeof this._data.zoomLevel == "number" && this.zoomLevel && this.zoomLevel != this._data.zoomLevel) {
                        this.set('zoomLevel', this._data.zoomLevel);
                    }
                }, 500);
            },
            _emit: function() {
                this.debounce('emit', function(){
                    console.log('emit');
                    console.log(this.socket);
                    var self = this;
                    if (this.socket) {
                        console.log(this.socket);
                        console.log('emit control');
                        self.socket.emit('update_map', {lonLat: this.lonLat, zoomLevel: this.zoomLevel});
                    }
                }, 1);
            }
        });
    </script>
</dom-module>
