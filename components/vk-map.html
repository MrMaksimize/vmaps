<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
<dom-module id="vk-map">
    <style>
        #map {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
            }
    </style>
    <link rel="import" href="../bower_components/polymer/polymer.html" />
    <link rel="import" href="./vk-layer.html">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.1/mapbox-gl-geocoder.css' type='text/css' />
    <template>
        <div id="map"></div>
    </template>

    <script type="text/javascript">
        Polymer({
            is: 'vk-map',
            properties: {
                /**
                * lonLat listen from the outside world for a new lat/lon pair (i.e.)
                * a pair of coordinates) and update the map with the result.
                *
                * @property lonLat
                * @type Array
                * @default [-74.50, 40]
                */
                lonLat: {
                    type: Array,
                    value: function(){
                        return [-117.16, 32.71]
                    },
                    notify: true,
                    reflectToAttribute: true,
                },
                /*bounds: {
                    type: Array,
                    value: function(){
                        return [
                            [-117.309797, 32.534871]
                            [-116.905723, 33.114185]
                        ]
                    }
                },*/
                dataSets: {
                    type: Array,
                    value: function(){
                        return [];
                    },
                },
                zoomLevel: {
                    type: Number,
                    // can't figure out why i can't provide default here.
                    value: function(){
                        return 7;
                    },
                    notify: true,
                    reflectToAttribute: true,
                    observer: '_handleMapZoomChange'

                },
                map: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true,
                },

                _userIsMovingMap: {
                    type: Boolean,
                    value: false
                },
                _userIsZoomingMap: {
                    type: Boolean,
                    value: false
                }
            },

            observers: [
                //TODO -- these three should be an object
                '_handleMapGeoChange(lonLat.*)',
                '_updateMapData(dataSets.*)'
            ],
            ready: function() {
                this.addEventListener('layerAdded', this.layerAdded);
            },
            layerAdded: function(e) {
                console.log(e);
            },

            attached: function() {
                console.log('map ready');
                mapboxgl.accessToken = 'pk.eyJ1IjoibXJtYWtzaW1pemUiLCJhIjoiRlRwLWwyVSJ9.--Y4RdEJ_5ZuJjSUkx34vQ';
                var self = this;
                this.map = new mapboxgl.Map({
                    container: 'map', // container id
                    style: 'mapbox://styles/mapbox/dark-v9', //stylesheet location
                    center: this.lonLat, // starting position
                    zoom: this.zoomLevel // starting zoom
                });
                this.map.on('move', function(){
                    this._userMovingMap();
                    // center = self.map.getCenter()
                    // self.lonLat = [center.lng, center.lat]
                }.bind(self));

                this.map.on('movestart', function(){
                    this.set('_userIsMovingMap', true);
                }.bind(this));

                this.map.on('moveend', function(){
                    this.async(function(){
                        this.set('_userIsMovingMap', false);
                    }, 100);
                }.bind(this));


                this.map.on('zoom', function(){
                    this._userMovingMap();
                    // center = self.map.getCenter()
                    // self.lonLat = [center.lng, center.lat]
                }.bind(self));

                this.map.on('zoomstart', function(){
                    this.set('_userIsZoomingMap', true);
                }.bind(this));

                this.map.on('zoomend', function(){
                    this.async(function(){
                        this.set('_userIsZoomingMap', false);
                    }, 100);
                }.bind(this));




                // In theory this should never happen
                /*this.map.on('zoomend', function() {
                    self.zoomLevel = this.getZoom()
                })*/
                this.layerChildren = {};

            },

            // listeners : [ 'map.moveend' : '_handleFormSubmit' ]

            _userMovingMap: function() {
                if (this.map) {
                    this.debounce('handleMapMove', function(){
                        var mapCenter = this.map.getCenter();
                        if (mapCenter.lat && mapCenter.lng && (typeof mapCenter.lat === "number") && (typeof mapCenter.lng === "number")) {
                            this.set('lonLat', [mapCenter.lng, mapCenter.lat]);
                        }
                        var mapZoom = this.map.getZoom();
                        if (mapZoom && typeof mapZoom === "number") {
                            this.set('zoomLevel', mapZoom);
                        }
                    }, 1);
                }
            },

            _handleMapGeoChange: function() {
                // If this.lonLat is different from map, sync map
                // If this.zoomLevel is different from map, sync map
                if (this.map) {
                    console.log('update map called');
                    var center = this.map.getCenter();
                    var mapZoom = this.map.getZoom();
                    console.log(center)
                    console.log(this.lonLat);
                    var mapLat = center.lat;
                    var mapLon = center.lng;
                    var modelLat = this.lonLat[1];
                    var modelLon = this.lonLat[0];

                    if ((mapLat !== modelLat) || (mapLon !== modelLon) || (mapZoom != this.mapZoom)) {
                        this._redrawMap();

                    }
                }
            },

            _handleMapZoomChange: function() {
                if(this.map) {
                    console.log('update zoom called')
                    var mapZoom = this.map.getZoom();
                    if (this.zoomLevel && this.zoomLevel != mapZoom) {
                        this._redrawMap();
                    }
                }
            },

            _redrawMap: function() {
                if (this.map && this.lonLat && !this._userIsMovingMap && !this._userIsZoomingMap) {

                    console.log('update map');
                    console.log(this.lonLat);
                    debugger;
                    this.map.easeTo({
                        center: this.lonLat,
                        zoom: this.zoomLevel
                    });
                    //this.map.setCenter(this.lonLat);

                }
            },

            _updateMapData: function() {
                if (this.map) {
                    console.log('update');
                    if (this.dataSets.length == 0 && this.map) {
                        for (var layer in this.layerChildren) {
                            this.layerChildren[layer].set('visibility', 'none');
                        }
                    }
                    else {
                        console.log(this.dataSets[0]);
                        this.map.getLayer(this.dataSets[0]);
                        for (var i = 0; i < this.dataSets.length; i++) {
                            var dataSet = this.dataSets[i];
                            console.log(dataSet);
                            if (this.layerChildren[dataSet]) {
                                this.layerChildren[dataSet].set('visibility', 'visible');
                            }
                            else {
                                var layerEl = document.createElement("vk-layer");
                                // TODO -- idk if this is necessary.
                                layerEl.setAttribute('map', "{{map}}");
                                layerEl.setAttribute('data-set', dataSet);
                                layerEl.set('map', this.map);
                                this.appendChild(layerEl);
                                this.layerChildren[dataSet] = layerEl;
                            }
                        }
                    }
                }
            }
        });
    </script>
</dom-module>
