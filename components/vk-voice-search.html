<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="./vk-icon-toggle.html">
<dom-module id="vk-voice-search">
    <style>
      :host {
        --icon-toggle-color: lightgrey;
        --icon-toggle-outline-color: black;
        --icon-toggle-pressed-color: red;        
        font-family: sans-serif;
      };
    </style>
    <template>
        <div id="voice-search">[[phrase]]</div>
        <input id="voice-search" value="{{phrase::change}}"></input>
        <iron-ajax
            id="ajax"
            url="https://api.api.ai/v1/query?v=20150910"
            handle-as="json"
            on-response="_handleResponse"
            debounce-duration="300"
            content-type="application/json; charset=utf-8"
            method="POST",
            headers='{"Authorization": "Bearer 2ddcc06c5f9b4afcb7b7287b5c76db70"}'>
        </iron-ajax>
        <!--<vk-icon-toggle toggle-icon="star" active={{active}}></vk-icon-toggle>-->
    </template>
</dom-module>

<script type="text/javascript">
    Polymer({
        is: 'vk-voice-search',
        properties: {
          active: {
              type: Boolean,
              value: false,
              reflectToAttribute: true
          },
        /**
        * phrase broadcasts the current active phrase.
        *
        * @property phrase
        * @type String
        * @default ""
        */
        phrase: {
            type: String,
            value: "Say something...",
            observer: '_phraseChanged'
        }
        },

        ready: function() {
            console.log('ready');
            //this.$['voice-search'].textContent = this.phrase;
        },
        _handleResponse: function(request) {
           console.log(this.$.ajax.lastResponse);
           data = this.$.ajax.lastResponse;
           if (data.result.parameters.location['zip-code']) {
             //geocoder.query(data.result.parameters.location['zip-code']);
             console.log("zip-code " + data.result.parameters.location['zip-code'])
           } else if (data.result.parameters.location['street-address']) {
             //geocoder.query(data.result.parameters.location['street-address'])
             console.log("street-address " + data.result.parameters.location['street-address'])
           } else if (data.result.parameters.location['geo-city-us']) {
             //geocoder.query(data.result.parameters.location['geo-city-us'])
             console.log("geo-city-us " + data.result.parameters.location['geo-city-us'])
           }
        },
        _phraseChanged: function(newPhrase, oldPhrase) {
            console.log(newPhrase);
            console.log(oldPhrase);
            if (oldPhrase) {
                this.$.ajax.body = JSON.stringify({
                            q: newPhrase,
                            lang: "en",
                            sessionId: "polymap-1"
                        });
                console.log(this.$.ajax)
                this.$.ajax.generateRequest();
            }
    }
    });
</script>
